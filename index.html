<html>

<head>
   <meta charset="UTF-8">
   <meta http-equiv="X-UA-Compatible" content="IE=edge">
   <meta name="viewport" content="width=device-width, initial-scale=1.0">

   <!-- Latest version of msal-browser.js from CDN as of 2022/09 -->
   <script type="text/javascript" src="https://alcdn.msauth.net/browser/2.28.1/js/msal-browser.min.js">
   </script>
   <style>
      body {
         font-family: 'Segoe UI';
         background-color: #E8EBFF;
      }

      table {
         border-collapse: collapse;
      }

      td,
      th {
         border: 1px solid black;
      }

      #message {
         color: green;
      }

      .input {
         display: block;
         padding: 10px 20px;
         font-size: 12px;
         color: blue;
         width: 100%;
         margin: 5px 0;
         outline: none;
         border: none;
      }

      #loginButton {
         padding: 17px 43px;
         background: #383680;
         color: white;
      }


      #mainCredentials{
            display:flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 40px;
         }

         #mainCredentials input{
            padding: 10px 20px;
            gap: 10px;
            font-size: 12px;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
            outline: none;
            color: #383680;
            border: none;
         }

         #mainCredentials h1{
            color: #232332;
            font-size: 17px;
            font-style: normal;
            font-weight: 400;
            line-height: normal;
         }

         #loginButton:disabled{
            background-color: gray;
            color: white;
            cursor: no-drop;
         }

         .list{
            visibility: hidden;
            position: absolute;
         }
   </style>
</head>

<body>
   <div>
      <div id="mainCredentials">
         <h1>Azure AD B2C application credentials to access Dynamics 365 CRM</h1>
         <input id="clientIdInput" type="text" placeholder="ClientID">
         <input id="tenantIdInput" type="text" placeholder="TenantID">
         <input id="crmUrlInput" type="text" placeholder="CRM url">

         <a href="https://www.youtube.com/" target="_blank">Link to tutorial on Youtube</a>
      </div>

      <button id="logoutButton" onclick="signOut()" style="display:none;">Logout</button>
      <button id="getAccountsButton" onclick="getAccounts(writeTable)" style="display:none;">Get Accounts</button>
      <button id="sendAccountsButton" onclick="sendAccounts(writeTable)" style="display:none;">Send new
         Accounts</button>
      <div id="message"></div>
      <div id="list"></div>

      <button id="loginButton" disabled onclick="signIn()">Login</button>
   </div>

   <script src="./main.js"></script>
   <script>
      const loginButton = document.getElementById("loginButton");
      const logoutButton = document.getElementById("logoutButton");
      const getAccountsButton = document.getElementById("getAccountsButton");
      const sendAccountsButton = document.getElementById("sendAccountsButton");
      const accountsTable = document.getElementById("accountsTable");
      const accountsTableBody = document.getElementById("accountsTableBody");
      const message = document.getElementById("message");

      const mainCredentialsForm = document.getElementById('mainCredentials')
      const clientIdInput = document.getElementById("clientIdInput");
      const tenantIdInput = document.getElementById("tenantIdInput");
      const crmUrlInput = document.getElementById("crmUrlInput");

      // Create the main myMSALObj instance


      const baseUrl = "https://orgfdbab4d2.api.crm.dynamics.com";      //<= Change this
      const clientId = "8d5c861b-044a-4978-b3ac-d9d913169ff2"; //<= Change this
      const tenantId = "b1f4d83b-a807-43ec-b4af-fc3b4c20f9c1"; //<= Change this
      const redirectUrl = "/";
      const webAPIEndpoint = baseUrl + "/api/data/v9.2";



        // Called from signIn or selectAccount functions
      function showWelcomeMessage(username) {
         message.innerHTML = `Welcome ${username}`;
         loginButton.style.display = "none";
         logoutButton.style.display = "block";
         getAccountsButton.style.display = "block";
         sendAccountsButton.style.display = "block";
         list.style.visibility = 'visible'
         list.style.position = 'relative'
         mainCredentialsForm.style.display = 'none'
      }



      // Configuration object to be passed to MSAL instance on creation. 

      const msalConfig = {
         auth: {
            clientId: clientId,
            // Full directory URL, in the form of https://login.microsoftonline.com/<tenant-id>
            authority: "https://login.microsoftonline.com/" + tenantId,
            redirectUri: redirectUrl,
         },
         cache: {
            cacheLocation: "localStorage" // This configures where your cache will be stored
         },
         system: {
            loggerOptions: {
               loggerCallback: (level, message, containsPii) => {
                  if (containsPii) {
                     return;
                  }
                  switch (level) {
                     case msal.LogLevel.Error:
                        console.error(message);
                        return;
                     case msal.LogLevel.Info:
                        console.info(message);
                        return;
                     case msal.LogLevel.Verbose:
                        console.debug(message);
                        return;
                     case msal.LogLevel.Warning:
                        console.warn(message);
                        return;
                  }
               }
            }
         }
      };



      const myMSALObj = new msal.PublicClientApplication(msalConfig);






      // new part here 


      



      
      function checkCredentialURLs() {
         if (clientIdInput.value !== '' && tenantIdInput.value !== '' && crmUrlInput.value !== '') {
            loginButton.removeAttribute('disabled');

            console.log("test is not disabled")
         } else {
            loginButton.setAttribute('disabled', 'true');
            console.log("test is  disabled")
         }
      }


      clientIdInput.addEventListener('input', checkCredentialURLs);
      tenantIdInput.addEventListener('input', checkCredentialURLs);
      crmUrlInput.addEventListener('input', checkCredentialURLs);



      // new part finished here 






      let contacts = null;
      let accounts = null;


      let username = "";

      // Sets the username. Called at the end of this script.
      function selectAccount() {

         const currentAccounts = myMSALObj.getAllAccounts();
         if (currentAccounts.length === 0) {
            return;
         } else if (currentAccounts.length > 1) {
            // Add choose account code here
            console.warn("Multiple accounts detected.");
         } else if (currentAccounts.length === 1) {
            username = currentAccounts[0].username;
            showWelcomeMessage(username);
         }
      }


      const changeRequestedNames = (name) => {
         switch (name) {
            case 'userName':
               return 'fullName';
            case 'jobTitle':
               return 'jobtitle';
            case 'location':
               return 'address1_name';
            case 'customer':
               return 'parentcustomerid_account';
            case 'phone':
               return 'mobilephone';
            case 'email':
               return 'emailaddress1';
            case 'linkedinUrl':
               return "uds_linkedin"
            case 'customerId':
               return "uds_linkedincompanyid"
            case 'companyName':
               return "name"
            case 'numberOfWorkers':
               return "numberofemployees"
            case 'companyUrl':
               return "websiteurl"
            case 'idOfCompany':
               return "uds_linkedincompanyid"
            case 'linkedinUrl':
               return "uds_linkedinprofilecompanyurl"
            default:
               return "aaa";
         }
      }

      // Called by the loginButton
      function signIn() {
         myMSALObj.loginPopup({
            scopes: ["User.Read", baseUrl + "/user_impersonation"] //<= Includes Dataverse scope
         })
            .then(response => {
               if (response !== null) {
                  username = response.account.username;
                  showWelcomeMessage(username);
               } else {
                  selectAccount();
               }
            })
            .catch(error => {
               console.error(error);
            });
      }

      // Shows greeting and enables logoutButton and getAccountsButton
    


      // Called by the logoutButton
      function signOut() {

         const logoutRequest = {
            account: myMSALObj.getAccountByUsername(username),
            postLogoutRedirectUri: msalConfig.auth.redirectUri,
            mainWindowRedirectUri: msalConfig.auth.redirectUri
         };

         myMSALObj.logoutPopup(logoutRequest);
      }

      // Provides the access token for a request, opening pop-up if necessary.
      // Used by GetAccounts function
      function getTokenPopup(request) {

         request.account = myMSALObj.getAccountByUsername(username);

         return myMSALObj.acquireTokenSilent(request)
            .catch(error => {
               console.warn("Silent token acquisition fails. Acquiring token using popup");
               if (error instanceof msal.InteractionRequiredAuthError) {
                  // fallback to interaction when silent call fails
                  return myMSALObj.acquireTokenPopup(request)
                     .then(tokenResponse => {
                        console.log(tokenResponse);
                        return tokenResponse;
                     }).catch(error => {
                        console.error(error);
                     });
               } else {
                  console.warn(error);
               }
            });
      }


      // get url parameters and show inside list


      let urlParameters = {}

      const url = new URL(window.location.href);

      url.searchParams.forEach((value, name) => {
         urlParameters = JSON.parse(value)
         console.log(value, 'value')
      });

      console.log(urlParameters, 'urlParameters')


      const list = document.getElementById('list')
      console.log(list, 'list')

      const entries = Object.entries(urlParameters);

      for (const [key, value] of entries) {
         const inputElement = document.createElement('input')
         inputElement.value = value
         inputElement.classList.add('input')
         inputElement.placeholder = key
         inputElement.name = key
         list && list.appendChild(inputElement)
      }


      // get url parameters and show inside list end


      // Retrieves top 10 account records from Dataverse
      function getAccounts(callback) {
         // Gets the access token
         getTokenPopup({
            scopes: [baseUrl + "/.default"]
         })
            .then(response => {
               //filter accounts?$select=name&$filter=contains(name,'Eljan')
               getDataverse("accounts", response.accessToken, callback);
            }).catch(error => {
               console.error(error);
            });
      }

      async function getContacts(callback) {
         // Gets the access token
         const response = await getTokenPopup({scopes: [baseUrl + "/.default"]})
         getDataverse("contacts", response.accessToken, callback);
      }




      async function filterBackend(url, callback) {
         // Gets the access token
         // "contacts?$select=name&$filter=contains(name,'Eljan')"

         const response = await getTokenPopup({ scopes: [baseUrl + "/.default"] });
         const data = await getDataverse(url, response.accessToken, callback);
         return data

      }

      async function sendAccounts(callback) {


         const response = await  getTokenPopup({scopes: [baseUrl + "/.default"]})

         if (!urlParameters['companyName']) {
            console.log("nani yoxdur")
            getContacts()
            sendDataverse("contacts", response.accessToken, callback);
         } else {
            console.log("nani vardir")
            createCompany("accounts", response.accessToken)
         }

      }


      /** 
       * Helper function to get data from Dataverse
      * using the authorization bearer token scheme
      * callback is the writeTable function below
      */
      async function getDataverse(url, token, callback) {
         const headers = new Headers();
         const bearer = `Bearer ${token}`;
         headers.append("Authorization", bearer);
         // Other Dataverse headers
         headers.append("Accept", "application/json");
         headers.append("OData-MaxVersion", "4.0");
         headers.append("OData-Version", "4.0");

         const options = {
            method: "GET",
            headers: headers,

         }

         console.log('GET Request made to Dataverse at: ' + new Date().toString());

         const response = await fetch(webAPIEndpoint + "/" + url, options);
         const data = response.json()
         return data

      }


      const createCompanyWithId = async (url, token) => {
         message.innerHTML = 'Loading...'
         const headers = new Headers();
         const bearer = `Bearer ${token}`;
         headers.append("Authorization", bearer);
         // Other Dataverse headers
         headers.append("Accept", "application/json");
         headers.append("OData-MaxVersion", "4.0");
         headers.append("OData-Version", "4.0");
         headers.append("Content-Type", "application/json");

         const entries = Object.entries(urlParameters);
         const dataObjectForRequest = {}

         const options = {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
               uds_linkedincompanyid: urlParameters['customerId']
            })
         }

         console.log('GET Request made to Dataverse at: ' + new Date().toString());


         const response = fetch(webAPIEndpoint + "/" + url, options)
         const data = response ? response.json() : true
         return data
      }


      const createCompany = async (url, token) => {
         message.innerHTML = 'Loading Company...'
         const headers = new Headers();
         const bearer = `Bearer ${token}`;
         headers.append("Authorization", bearer);
         // Other Dataverse headers
         headers.append("Accept", "application/json");
         headers.append("OData-MaxVersion", "4.0");
         headers.append("OData-Version", "4.0");
         headers.append("Content-Type", "application/json");
         console.log(urlParameters,'Company urlParameters')
         let requestData = {}
         for (const [key, value] of Object.entries(urlParameters)) {
            requestData[changeRequestedNames(key)] = value
         }

         const options = {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
               uds_linkedincompanyid: Number(requestData['uds_linkedincompanyid']),
               name:requestData['name'],
               numberofemployees:requestData['numberofemployees'],
               uds_linkedin:requestData['uds_linkedin'],
               websiteurl:requestData['websiteurl'],
            })
         }

         console.log('GET Request made to Dataverse at: ' + new Date().toString());


         const response = fetch(webAPIEndpoint + "/" + url, options)
         const data = response ? response.json() : true
         return data
      }








      const createAccount = async (url, token) => {

         const headers = new Headers();
         const bearer = `Bearer ${token}`;
         headers.append("Authorization", bearer);
         // Other Dataverse headers
         headers.append("Accept", "application/json");
         headers.append("OData-MaxVersion", "4.0");
         headers.append("OData-Version", "4.0");
         headers.append("Content-Type", "application/json");
         headers.append("Prefer", 'odata.include-annotations="*"');
         const entries = Object.entries(urlParameters);
         const dataObjectForRequest = {}
         for (const [key, value] of entries) {
            dataObjectForRequest[changeRequestedNames(key)] = value
         }

         dataObjectForRequest['firstname'] = dataObjectForRequest.fullName.split(" ")[0]
         dataObjectForRequest['lastname'] = dataObjectForRequest.fullName.split(" ")[1]

         const options = {
            method: "POST",
            headers: headers,
            body: JSON.stringify({
               firstname: dataObjectForRequest.fullName.split(" ")[0],
               lastname: dataObjectForRequest.fullName.split(" ")[1],
               fullname: dataObjectForRequest.fullName,
               jobtitle: dataObjectForRequest.jobtitle,
               address1_name: dataObjectForRequest.address1_name,
               // _parentcustomerid_value: accounts.filter(account=>account.uds_linkedincompanyid === urlParameters['customerId'])[0].accountid,
               'parentcustomerid_account@odata.bind': `/accounts(${accounts.filter(account => account.uds_linkedincompanyid === urlParameters['customerId'])[0].accountid})`,
               telephone1: dataObjectForRequest.telephone1,
               mobilephone: dataObjectForRequest.mobilephone,
               emailaddress1: dataObjectForRequest.emailaddress1
            })
         }

         console.log('GET Request made to Dataverse at: ' + new Date().toString());
         const response = await fetch(webAPIEndpoint + "/" + url, options)
         const data = response.json()
      }

      async function sendDataverse(url, token, callback) {
         // filterBackend(`accounts?$select=uds_linkedincompanyid&$filter=contains(uds_linkedincompanyid,123123)`, writeTable)
         const filtered = await filterBackend(`accounts`, writeTable)
         accounts = filtered.value


         if (filtered.value.some(account => account.uds_linkedincompanyid === urlParameters['customerId'])) {
            console.log('there have company with this id' + urlParameters['customerId'])
            message.innerHTML = 'there have company with this id' + urlParameters['customerId']
            createAccount('contacts', token)
         } else {
            message.innerHTML = '0 company find. You need to create company first'
            const createdCompany = await createCompanyWithId('accounts', token)
            console.log(createdCompany, 'createdCompany')
            message.innerHTML = 'Company created'
            createAccount('contacts', token)

         }
      }




      // Renders the table with data from GetAccounts
      function writeTable(data) {
         console.log(data, 'dataaa i am back')
         // if(data.value.some(account=>account.uds_linkedincompanyid === urlParameters['customerId'])){
         //    console.log('there have company with this id' + urlParameters['customerId'])
         //    message.innerHTML = 'there have company with this id' + urlParameters['customerId']
         // }else{
         //    console.log('0 company find')

         //    message.innerHTML = '0 company find. You need to create company first'
         // }
      }

      selectAccount();
   </script>
</body>

</html>